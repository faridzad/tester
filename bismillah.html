<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catatan Pengeluaran Operasional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <div class="max-w-3xl mx-auto p-6">

    <h1 class="text-2xl font-bold mb-6 text-center text-blue-700">Catatan Pengeluaran Operasional</h1>

    <!-- Form Input -->
    <section class="bg-white p-6 rounded-xl shadow-md mb-8">
      <form id="expenseForm" class="space-y-4">
        <input type="text" id="username" placeholder="Username" required class="w-full border rounded p-2" />
        <input type="date" id="tanggal" required class="w-full border rounded p-2" />
        <input type="text" id="kategori" placeholder="Kategori" required class="w-full border rounded p-2" />
        <input type="number" id="nominal" placeholder="Nominal" required class="w-full border rounded p-2" />
        <input type="text" id="keterangan" placeholder="Keterangan (opsional)" class="w-full border rounded p-2" />
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Simpan</button>
      </form>
      <p id="statusMessage" class="text-center text-sm mt-3 text-green-600 font-medium"></p>
    </section>

    <!-- Grafik Semua User -->
    <section class="bg-white p-6 rounded-xl shadow-md mb-8">
      <h2 class="text-xl font-semibold mb-2">Grafik Semua User</h2>
      <canvas id="chartAllUser"></canvas>
    </section>

    <!-- Grafik Per User -->
    <section class="bg-white p-6 rounded-xl shadow-md mb-8">
      <h2 class="text-xl font-semibold mb-2">Grafik Per User</h2>
      <select id="selectUser" class="mb-4 w-full border rounded p-2"></select>
      <canvas id="chartPerUser"></canvas>
    </section>

    <!-- Grafik Harian -->
    <section class="bg-white p-6 rounded-xl shadow-md">
      <h2 class="text-xl font-semibold mb-2">Grafik Harian</h2>
      <canvas id="chartHarian"></canvas>
    </section>

  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzWkvzHbowOTCr-Fsqv8ECyYIbSVZ8QYNn79OeKvm5HHm6zD_BlQnj8qQCIYSKvAg5FjA/exec'; // ganti dengan URL Web Apps Anda
    let chartAll, chartPerUser, chartHarian;

    document.getElementById("tanggal").valueAsDate = new Date();

    document.getElementById("expenseForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = {
        action: 'save',
        username: document.getElementById("username").value,
        tanggal: document.getElementById("tanggal").value,
        kategori: document.getElementById("kategori").value,
        nominal: document.getElementById("nominal").value,
        keterangan: document.getElementById("keterangan").value
      };

      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify(data),
          headers: { "Content-Type": "application/json" }
        });

        const result = await res.json();
        document.getElementById("statusMessage").textContent = result.message || 'Disimpan';
        document.getElementById("expenseForm").reset();
        document.getElementById("tanggal").valueAsDate = new Date();
        loadAll();
      } catch (err) {
        document.getElementById("statusMessage").textContent = "Gagal menyimpan.";
      }
    });

    async function loadAll() {
      const [allData, users] = await Promise.all([
        fetch(scriptURL + "?action=getAllData").then(r => r.json()),
        fetch(scriptURL + "?action=getUsers").then(r => r.json())
      ]);

      renderAllUserChart(allData);
      renderUserDropdown(users, allData);
      renderHarianChart(allData);
    }

    function renderAllUserChart(data) {
      const labels = Object.keys(data);
      const totals = labels.map(user =>
        data[user].reduce((sum, row) => sum + Number(row[2] || 0), 0)
      );

      if (chartAll) chartAll.destroy();
      chartAll = new Chart(document.getElementById("chartAllUser"), {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Total Pengeluaran",
            data: totals,
            backgroundColor: "#3b82f6"
          }]
        }
      });
    }

    function renderUserDropdown(users, allData) {
      const select = document.getElementById("selectUser");
      select.innerHTML = "";
      users.forEach(user => {
        const opt = document.createElement("option");
        opt.value = user;
        opt.textContent = user;
        select.appendChild(opt);
      });

      select.onchange = () => renderPerUserChart(allData[select.value]);
      renderPerUserChart(allData[users[0]]);
    }

    function renderPerUserChart(rows) {
      const dates = rows.map(r => r[0]);
      const values = rows.map(r => Number(r[2] || 0));

      if (chartPerUser) chartPerUser.destroy();
      chartPerUser = new Chart(document.getElementById("chartPerUser"), {
        type: "line",
        data: {
          labels: dates,
          datasets: [{
            label: "Pengeluaran Harian",
            data: values,
            borderColor: "#e67e22",
            fill: false
          }]
        }
      });
    }

    function renderHarianChart(allData) {
      const daily = {};

      Object.values(allData).forEach(rows => {
        rows.forEach(row => {
          const tgl = row[0];
          const nilai = Number(row[2] || 0);
          daily[tgl] = (daily[tgl] || 0) + nilai;
        });
      });

      const labels = Object.keys(daily);
      const values = Object.values(daily);

      if (chartHarian) chartHarian.destroy();
      chartHarian = new Chart(document.getElementById("chartHarian"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Total Harian",
            data: values,
            borderColor: "#10b981",
            fill: false
          }]
        }
      });
    }

    window.onload = loadAll;
  </script>
</body>
</html>
